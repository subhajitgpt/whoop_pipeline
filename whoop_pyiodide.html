<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Workout Analyzer (WHOOP-style) ‚Äî Pyodide</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body { padding: 20px; }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;white-space:pre-wrap}
    .img-box{border:1px solid #ddd;border-radius:8px;padding:6px;background:#fff}
    .min-h { min-height: 40px; }
    table { font-size: 0.95rem; }
  </style>
</head>
<body>
<div class="container">
  <h3 class="mb-3">üèÉ Workout Analyzer (WHOOP-style) ‚Äî Pyodide</h3>

  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">1) Upload Workout CSV
        <span id="ctx-badge" class="badge text-bg-secondary ms-2">Context: False</span>
      </h5>
      <div class="row g-2 align-items-center">
        <div class="col-auto"><input id="csvFile" class="form-control" type="file" accept=".csv" required></div>
        <div class="col-auto"><button id="analyzeBtn" class="btn btn-primary" disabled>Analyze</button></div>
        <div class="col-auto"><button id="clearBtn" class="btn btn-outline-secondary" disabled>Clear</button></div>
        <div class="col-auto"><button id="debugBtn" class="btn btn-outline-dark" disabled>Debug</button></div>
      </div>
      <div id="error" class="text-danger mt-2 min-h"></div>
      <div id="status" class="text-secondary small mt-2">üîÑ Initializing...</div>
    </div>
  </div>

  <div id="metricsCard" class="card mb-3 d-none">
    <div class="card-body">
      <h3 class="card-title">üìä Workout Metrics</h3>
      <div class="row">
        <div class="col-md-7">
          <h6>Average Metrics</h6>
          <div class="img-box"><img id="barImg" class="img-fluid" alt="Bar Chart"></div>
        </div>
        <div class="col-md-5">
          <h6>Activity Mix</h6>
          <div class="img-box" id="pieContainer">
            <img id="pieImg" class="img-fluid d-none" alt="Pie Chart">
            <div id="pieEmpty" class="text-secondary d-none">No activity data</div>
          </div>
        </div>
      </div>

      <hr>
      <div class="row">
        <div class="col-md-6">
          <h6>üèÜ Longest Sessions</h6>
          <div id="bestTable"></div>
        </div>
        <div class="col-md-6">
          <h6>‚ö° Shortest Sessions</h6>
          <div id="worstTable"></div>
        </div>
      </div>

      <hr>
      <div class="row">
        <div class="col-md-6"><ul id="leftStats"></ul></div>
        <div class="col-md-6"><ul id="rightStats"></ul></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h5 class="card-title">üí¨ Chat about your data</h5>
      <div id="noContext" class="text-secondary">Upload a CSV first for context.</div>
      <textarea id="promptBox" class="form-control mt-2" rows="3" placeholder="Ask about your workout data..."></textarea>
      <div class="mt-3"><button id="askBtn" class="btn btn-primary" disabled>Ask</button></div>
      <hr class="d-none" id="answerHr">
      <div id="answerDiv" class="d-none"><b>Assistant:</b><pre id="answer" class="mono"></pre></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js"></script>
<script>
let pyodide = null;
let isReady = false;
let contextText = "";

// Simple initialization - step by step
async function initPyodide() {
    const status = document.getElementById('status');
    
    try {
        status.textContent = "üîÑ Loading Pyodide...";
        pyodide = await loadPyodide();
        
        status.textContent = "üì¶ Loading packages...";
        await pyodide.loadPackage(['numpy', 'pandas', 'matplotlib']);
        
        status.textContent = "üîß Setting up functions...";
        
        // Load Python code exactly like your Flask version
        pyodide.runPython(`
import io, base64, re
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib import use
use('Agg')  # Set backend first

def plot_to_base64(fig):
    buf = io.BytesIO()
    fig.savefig(buf, format="png", bbox_inches="tight")
    buf.seek(0)
    img_b64 = base64.b64encode(buf.read()).decode("utf-8")
    plt.close(fig)
    return img_b64

def bar_chart(data, title=""):
    fig, ax = plt.subplots(figsize=(7, 3))
    ax.bar(list(data.keys()), list(data.values()))
    ax.set_title(title)
    ax.set_ylabel("Value")
    plt.xticks(rotation=20)
    return plot_to_base64(fig)

def pie_chart(labels, sizes, title):
    fig, ax = plt.subplots(figsize=(5, 5))
    
    # Handle NaN and negative values like Flask version
    sizes = np.array(sizes, dtype=float)
    sizes[np.isnan(sizes)] = 0
    sizes[sizes < 0] = 0
    total = sizes.sum()
    if total == 0:
        sizes = np.ones_like(sizes)
        total = sizes.sum()

    pct = sizes / total * 100.0
    explode = np.where(pct < 5, 0.04, 0.0)

    wedges, texts, autotexts = ax.pie(
        sizes,
        labels=None,
        explode=explode,
        autopct=lambda p: f"{p:.1f}%" if p >= 3 else "",
        startangle=120,
        pctdistance=0.78,
        labeldistance=1.08,
        wedgeprops=dict(width=0.42),
        normalize=True
    )

    legend_labels = [f"{l} ‚Äî {int(s)}" for l, s in zip(labels, sizes)]
    ax.legend(wedges, legend_labels, title=title, loc="center left",
              bbox_to_anchor=(1.0, 0.5), frameon=False)
    ax.text(0, 0, f"{int(total)}\\nTotal", ha="center", va="center", fontsize=11)
    ax.set_aspect("equal")
    ax.set_title(title)
    fig.tight_layout()
    return plot_to_base64(fig)

def fmt_num(n, digits=2):
    try:
        if n is None or np.isnan(n):
            return "N/A"
        return f"{float(n):,.{digits}f}"
    except:
        return "N/A"

def normalize_headers(df):
    def norm_col(c):
        c = c.strip().lower()
        c = re.sub(r"[^\\w]+", "_", c)
        c = re.sub(r"_{2,}", "_", c).strip("_")
        return c
    df = df.copy()
    df.columns = [norm_col(c) for c in df.columns]
    return df

def process_csv(csv_text):
    # Exactly like your Flask version
    df = pd.read_csv(io.StringIO(csv_text))
    df = normalize_headers(df)

    # Date handling
    if "workout_start_time" in df.columns:
        df["_date"] = pd.to_datetime(df["workout_start_time"], errors="coerce")
    elif "cycle_start_time" in df.columns:
        df["_date"] = pd.to_datetime(df["cycle_start_time"], errors="coerce")
    else:
        raise ValueError("CSV must include 'Workout start time' or 'Cycle start time'.")

    # Activity type
    df["_type"] = df["activity_name"] if "activity_name" in df.columns else "Workout"

    # Duration
    if "duration_min" in df.columns:
        df["_duration_min"] = pd.to_numeric(df["duration_min"], errors="coerce")
    elif "duration" in df.columns:
        df["_duration_min"] = pd.to_numeric(df["duration"], errors="coerce")
    else:
        raise ValueError("CSV must include 'Duration (min)' column.")

    # Optional metrics
    df["_avg_hr"] = pd.to_numeric(df.get("average_hr_bpm", np.nan), errors="coerce")
    df["_max_hr"] = pd.to_numeric(df.get("max_hr_bpm", np.nan), errors="coerce")
    df["_calories"] = pd.to_numeric(df.get("energy_burned_cal", np.nan), errors="coerce")
    df["_strain"] = pd.to_numeric(df.get("activity_strain", np.nan), errors="coerce")

    # Distance
    if "distance_meters" in df.columns:
        df["_distance_km"] = pd.to_numeric(df["distance_meters"], errors="coerce") / 1000.0
    else:
        df["_distance_km"] = np.nan

    df = df.sort_values("_date").reset_index(drop=True)
    total_rows = len(df)

    # Aggregations
    agg = {}
    agg["duration_min_mean"] = float(df["_duration_min"].mean()) if total_rows > 0 else 0.0
    
    distance_mean = df["_distance_km"].mean()
    agg["distance_km_mean"] = float(distance_mean) if not pd.isna(distance_mean) else None
    
    avg_hr_mean = df["_avg_hr"].mean()
    agg["avg_hr_mean"] = float(avg_hr_mean) if not pd.isna(avg_hr_mean) else None
    
    max_hr_mean = df["_max_hr"].mean()
    agg["max_hr_mean"] = float(max_hr_mean) if not pd.isna(max_hr_mean) else None
    
    calories_mean = df["_calories"].mean()
    agg["calories_mean"] = float(calories_mean) if not pd.isna(calories_mean) else None
    
    strain_mean = df["_strain"].mean()
    agg["strain_mean"] = float(strain_mean) if not pd.isna(strain_mean) else None

    # Weekly totals
    if total_rows > 0 and not df["_date"].isna().all():
        end = df["_date"].max()
        start = end - pd.Timedelta(days=6)
        mask = (df["_date"] >= start) & (df["_date"] <= end)
        agg["weekly_minutes"] = float(df.loc[mask, "_duration_min"].sum())
        agg["weekly_distance_km"] = float(df.loc[mask, "_distance_km"].sum()) if not df.loc[mask, "_distance_km"].isna().all() else 0.0
    else:
        agg["weekly_minutes"] = 0.0
        agg["weekly_distance_km"] = 0.0

    # Activity mix
    by_type = df["_type"].value_counts().to_dict()

    # Charts
    averages = {
        "Dur (min)": round(agg["duration_min_mean"], 2) if agg["duration_min_mean"] else 0,
        "Dist (km)": round(agg["distance_km_mean"], 2) if agg.get("distance_km_mean") else 0,
        "Avg HR": round(agg["avg_hr_mean"], 1) if agg.get("avg_hr_mean") else 0,
        "Max HR": round(agg["max_hr_mean"], 1) if agg.get("max_hr_mean") else 0,
        "Calories": round(agg["calories_mean"], 0) if agg.get("calories_mean") else 0,
        "Strain": round(agg["strain_mean"], 1) if agg.get("strain_mean") else 0,
    }
    bar_b64 = bar_chart(averages, "Average Key Workout Metrics")

    mix_labels, mix_sizes = list(by_type.keys()), list(by_type.values())
    pie_b64 = pie_chart(mix_labels, mix_sizes, "Activity Mix") if mix_labels else None

    # Tables
    if total_rows >= 3:
        top_long = df.nlargest(3, "_duration_min")[["_date","_type","_duration_min"]]
        low_long = df.nsmallest(3, "_duration_min")[["_date","_type","_duration_min"]]
    else:
        top_long = df.nlargest(total_rows, "_duration_min")[["_date","_type","_duration_min"]]
        low_long = df.nsmallest(total_rows, "_duration_min")[["_date","_type","_duration_min"]]
    
    best_html = top_long.rename(columns={"_date":"Date","_type":"Activity","_duration_min":"Minutes"}).to_html(index=False, escape=False)
    worst_html = low_long.rename(columns={"_date":"Date","_type":"Activity","_duration_min":"Minutes"}).to_html(index=False, escape=False)

    # Context
    lines = []
    lines.append(f"Rows (workouts): {len(df)}")
    lines.append(f"Avg Duration (min): {fmt_num(agg['duration_min_mean'])}")
    lines.append(f"Avg Distance (km): {fmt_num(agg.get('distance_km_mean'))}")
    lines.append(f"Avg HR (bpm): {fmt_num(agg.get('avg_hr_mean'))} | Max HR (bpm): {fmt_num(agg.get('max_hr_mean'))}")
    lines.append(f"Avg Strain: {fmt_num(agg.get('strain_mean'))} | Avg Calories: {fmt_num(agg.get('calories_mean'))}")
    lines.append(f"Weekly Volume (min): {fmt_num(agg['weekly_minutes'])} | Weekly Distance (km): {fmt_num(agg.get('weekly_distance_km'))}")
    lines.append("Mix by activity: " + ", ".join([f"{k}={v}" for k,v in by_type.items()]))
    context = "\\n".join(lines)

    return {
        'agg': agg,
        'bar_chart': bar_b64,
        'pie_chart': pie_b64,
        'best_html': best_html,
        'worst_html': worst_html,
        'context': context
    }

def coach_response(context, prompt):
    if not prompt.strip():
        return "Please ask me something about your workout data!"
    
    lines = [
        "üèÉ WORKOUT COACHING INSIGHTS:",
        "",
        "üí° KEY RECOMMENDATIONS:",
        "‚Ä¢ Keep weekly volume within ¬±15% of current average",
        "‚Ä¢ Alternate high and low intensity days", 
        "‚Ä¢ Include 1-2 complete rest days per week",
        "‚Ä¢ Monitor heart rate trends for overtraining signs",
        "‚Ä¢ Progress distance/duration gradually (10% rule)",
        "",
        "üìä YOUR DATA SUMMARY:",
        context[:400] + ("..." if len(context) > 400 else ""),
        "",
        "üéØ Ask about: training plans, recovery, performance trends!"
    ]
    return "\\n".join(lines)

print("‚úÖ Python setup complete!")
        `);
        
        status.textContent = "‚úÖ Ready to analyze!";
        status.className = "text-success small mt-2";
        isReady = true;
        
        // Enable buttons
        document.getElementById('analyzeBtn').disabled = false;
        document.getElementById('clearBtn').disabled = false;
        document.getElementById('debugBtn').disabled = false;
        document.getElementById('askBtn').disabled = false;
        
    } catch (error) {
        status.textContent = "‚ùå Failed: " + error.message;
        status.className = "text-danger small mt-2";
        console.error("Init error:", error);
    }
}

// Process CSV
async function analyzeCsv(csvText) {
    const status = document.getElementById('status');
    
    try {
        status.textContent = "üîÑ Processing...";
        document.getElementById('error').textContent = "";
        
        // Call Python function
        const result = pyodide.runPython(`process_csv("""${csvText.replace(/"/g, '\\"')}""")`);
        const data = result.toJs({dict_hook: Object});
        
        contextText = data.context || "";
        
        // Update charts
        if (data.bar_chart) {
            document.getElementById('barImg').src = "data:image/png;base64," + data.bar_chart;
        }
        
        const pieImg = document.getElementById('pieImg');
        const pieEmpty = document.getElementById('pieEmpty');
        
        if (data.pie_chart) {
            pieImg.src = "data:image/png;base64," + data.pie_chart;
            pieImg.classList.remove('d-none');
            pieEmpty.classList.add('d-none');
        } else {
            pieImg.classList.add('d-none');
            pieEmpty.classList.remove('d-none');
        }
        
        // Update tables
        document.getElementById('bestTable').innerHTML = data.best_html || "<p>No data</p>";
        document.getElementById('worstTable').innerHTML = data.worst_html || "<p>No data</p>";
        
        // Update stats
        const agg = data.agg || {};
        const fmt = (x, d=1) => (x == null || isNaN(x)) ? 'N/A' : Number(x).toFixed(d);
        
        document.getElementById('leftStats').innerHTML = `
            <li><b>Avg Duration:</b> ${fmt(agg.duration_min_mean, 2)} min</li>
            <li><b>Avg Distance:</b> ${agg.distance_km_mean ? fmt(agg.distance_km_mean, 2) + ' km' : 'N/A'}</li>
            <li><b>Avg Strain:</b> ${agg.strain_mean ? fmt(agg.strain_mean, 2) : 'N/A'}</li>
        `;
        
        document.getElementById('rightStats').innerHTML = `
            <li><b>Avg HR:</b> ${agg.avg_hr_mean ? fmt(agg.avg_hr_mean, 1) + ' bpm' : 'N/A'}</li>
            <li><b>Max HR:</b> ${agg.max_hr_mean ? fmt(agg.max_hr_mean, 1) + ' bpm' : 'N/A'}</li>
            <li><b>Weekly Volume:</b> ${fmt(agg.weekly_minutes, 1)} min</li>
        `;
        
        // Show results
        document.getElementById('metricsCard').classList.remove('d-none');
        document.getElementById('noContext').style.display = 'none';
        document.getElementById('ctx-badge').className = "badge text-bg-success ms-2";
        document.getElementById('ctx-badge').textContent = "Context: Ready";
        
        status.textContent = "‚úÖ Analysis complete!";
        status.className = "text-success small mt-2";
        
    } catch (error) {
        document.getElementById('error').textContent = "Error: " + error.message;
        status.textContent = "‚ùå Processing failed";
        status.className = "text-danger small mt-2";
        console.error("Processing error:", error);
    }
}

// Event handlers
document.getElementById('analyzeBtn').addEventListener('click', async () => {
    if (!isReady) {
        document.getElementById('error').textContent = "Please wait for initialization to complete.";
        return;
    }
    
    const file = document.getElementById('csvFile').files[0];
    if (!file) {
        document.getElementById('error').textContent = "Please select a CSV file.";
        return;
    }
    
    try {
        const text = await file.text();
        await analyzeCsv(text);
    } catch (error) {
        document.getElementById('error').textContent = "File error: " + error.message;
    }
});

document.getElementById('clearBtn').addEventListener('click', () => {
    contextText = "";
    document.getElementById('metricsCard').classList.add('d-none');
    document.getElementById('noContext').style.display = 'block';
    document.getElementById('ctx-badge').className = "badge text-bg-secondary ms-2";
    document.getElementById('ctx-badge').textContent = "Context: False";
    document.getElementById('error').textContent = "";
    document.getElementById('answer').textContent = "";
    document.getElementById('answerDiv').classList.add('d-none');
    document.getElementById('answerHr').classList.add('d-none');
    document.getElementById('csvFile').value = "";
    document.getElementById('status').textContent = "‚úÖ Ready to analyze!";
});

document.getElementById('debugBtn').addEventListener('click', () => {
    const info = {
        ready: isReady,
        has_context: !!contextText,
        context_length: contextText.length
    };
    alert(JSON.stringify(info, null, 2));
});

document.getElementById('askBtn').addEventListener('click', async () => {
    if (!contextText) {
        document.getElementById('error').textContent = "Upload a CSV first.";
        return;
    }
    
    const prompt = document.getElementById('promptBox').value.trim();
    if (!prompt) {
        document.getElementById('error').textContent = "Enter a question.";
        return;
    }
    
    try {
        const response = pyodide.runPython(`coach_response("""${contextText.replace(/"/g, '\\"')}""", """${prompt.replace(/"/g, '\\"')}""")`);
        
        document.getElementById('answerHr').classList.remove('d-none');
        document.getElementById('answerDiv').classList.remove('d-none');
        document.getElementById('answer').textContent = response;
        
    } catch (error) {
        document.getElementById('error').textContent = "Chat error: " + error.message;
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', initPyodide);
</script>
</body>
</html>