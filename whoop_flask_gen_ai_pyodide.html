<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Health & Sleep Analyzer — Pyodide</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body { padding: 20px; }
    .monospace { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; }
    .img-box { border: 1px solid #ddd; border-radius: 8px; padding: 6px; background: #fff; }
    .min-h { min-height: 40px; }
    table { font-size: 0.95rem; }
  </style>
</head>
<body>
<div class="container my-4">

  <div class="card mb-3">
    <div class="card-body">
      <h5 class="card-title">1) Upload WHOOP CSV
        <span id="ctx-badge" class="badge text-bg-secondary ms-2">Context: False</span>
      </h5>
      <div class="row g-2 align-items-center">
        <div class="col-auto"><input id="csvFile" class="form-control" type="file" accept=".csv" required></div>
        <div class="col-auto"><button id="analyzeBtn" class="btn btn-primary" disabled>Analyze</button></div>
        <div class="col-auto"><button id="clearBtn" class="btn btn-outline-secondary" disabled>Clear context</button></div>
        <div class="col-auto"><button id="debugBtn" class="btn btn-outline-dark" disabled>/debug</button></div>
      </div>
      <div id="error" class="text-danger mt-2 min-h"></div>
      <div id="status" class="text-secondary small mt-2">🔄 Initializing Python environment...</div>
    </div>
  </div>

  <div id="metricsCard" class="card mb-3 d-none">
    <div class="card-body">
      <h3 class="card-title">Extracted Metrics</h3>

      <div class="row">
        <div class="col-md-7">
          <h6>Overall Metrics (Bar Chart)</h6>
          <div class="img-box"><img id="barChart" class="img-fluid" alt="Average Metrics"></div>
        </div>
        <div class="col-md-5">
          <h6>Recovery & Sleep Debt Proportions</h6>
          <div class="row">
            <div class="col-6">
              <div class="img-box"><img id="pieRecovery" class="img-fluid" alt="Low Recovery Pie"></div>
            </div>
            <div class="col-6">
              <div class="img-box"><img id="pieSleepDebt" class="img-fluid" alt="High Sleep Debt Pie"></div>
            </div>
          </div>
        </div>
      </div>

      <hr>

      <div class="row">
        <div class="col-md-6">
          <h6>Recovery Score Distribution</h6>
          <table class="table table-sm table-striped">
            <thead><tr><th>Category</th><th>Days</th></tr></thead>
            <tbody id="recoveryDistTable">
            </tbody>
          </table>
        </div>
        <div class="col-md-6">
          <h6>Sleep Debt Distribution</h6>
          <table class="table table-sm table-striped">
            <thead><tr><th>Category</th><th>Days</th></tr></thead>
            <tbody id="sleepDebtDistTable">
            </tbody>
          </table>
        </div>
      </div>

      <hr>

      <h6>Highlights</h6>
      <div class="row">
        <div class="col-md-6">
          <h6>Top 3 Best Recovery Days</h6>
          <div id="bestRecovery"></div>
          <h6 class="mt-3">Top 3 Worst Recovery Days</h6>
          <div id="worstRecovery"></div>
        </div>
        <div class="col-md-6">
          <h6>Top 3 Highest Sleep Debt Days</h6>
          <div id="highestSleepDebt"></div>
          <h6 class="mt-3">Top 3 Lowest Sleep Debt Days</h6>
          <div id="lowestSleepDebt"></div>
        </div>
      </div>

    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h5 class="card-title">2) Chat about this data</h5>
      <div id="noContext" class="text-secondary">Upload a CSV first to give the assistant context. You can still type a question—I'll remind you.</div>
      <textarea id="promptBox" class="form-control" rows="4" placeholder="E.g., Suggest a 7-day plan to improve HRV given my averages and bad days."></textarea>
      <div class="mt-3">
        <button id="askBtn" class="btn btn-primary" disabled>Ask</button>
      </div>
      <hr class="d-none" id="answerHr">
      <div id="answerDiv" class="d-none">
        <div><b>Assistant:</b></div>
        <pre id="answer" class="monospace"></pre>
      </div>
    </div>
  </div>

</div>

<!-- Pyodide loader -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js"></script>
<script>
let pyodide = null;
let isReady = false;
let contextText = "";

// Initialize Pyodide
async function initPyodide() {
    const status = document.getElementById('status');
    
    try {
        status.textContent = "🔄 Loading Pyodide...";
        pyodide = await loadPyodide();
        
        status.textContent = "📦 Installing packages...";
        await pyodide.loadPackage(['numpy', 'pandas', 'matplotlib']);
        
        status.textContent = "🔧 Setting up functions...";
        
        // Load all Python functions - exact replica of Flask version
        pyodide.runPython(`
import io, base64
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib import use
use('Agg')  # Use non-interactive backend

def plot_to_base64(fig):
    buf = io.BytesIO()
    fig.savefig(buf, format="png", bbox_inches='tight')
    buf.seek(0)
    img_base64 = base64.b64encode(buf.read()).decode('utf-8')
    plt.close(fig)
    return img_base64

def make_bar_chart(averages):
    fig, ax = plt.subplots(figsize=(7, 3))
    ax.bar(list(averages.keys()), list(averages.values()))  # default colors
    ax.set_ylabel('Average Value')
    ax.set_title('Average Key Metrics')
    plt.xticks(rotation=20)
    return plot_to_base64(fig)

def make_pie_chart(labels, sizes, title):
    fig, ax = plt.subplots(figsize=(8, 8))
    ax.pie(sizes, labels=labels, autopct='%1.1f%%', startangle=90)
    ax.set_title(title)
    return plot_to_base64(fig)

def df_to_summary_context(df, summary_stats, recovery_dist, sleep_debt_dist, low_recovery, high_sleep_debt):
    lines = []
    lines.append(f"Rows (days): {len(df)}")
    lines.append(f"Avg Recovery: {summary_stats['Recovery_score_']['mean']}")
    lines.append(f"Avg Rest HR (bpm): {summary_stats['Resting_heart_rate_(bpm)']['mean']}")
    lines.append(f"Avg HRV (ms): {summary_stats['Heart_rate_variability_(ms)']['mean']}")
    lines.append(f"Avg Sleep Perf: {summary_stats['Sleep_performance_']['mean']}")
    if "Sleep_debt_(min)" in df.columns:
        lines.append(f"Avg Sleep Debt (min): {round(df['Sleep_debt_(min)'].mean(),2)}")
        lines.append(f"High Sleep Debt Days (>100): {len(high_sleep_debt)}")
    lines.append(f"Recovery Dist Low/Med/High: {recovery_dist}")
    if sleep_debt_dist:
        lines.append(f"Sleep Debt Dist Low/Moderate/High: {sleep_debt_dist}")
    return "\\n".join(lines)

def process_whoop_csv(csv_text):
    """Main function to process WHOOP CSV data"""
    df = pd.read_csv(io.StringIO(csv_text))
    df.columns = df.columns.str.strip()

    # Verify required columns
    required_cols = ["Recovery_score_", "Resting_heart_rate_(bpm)", "Heart_rate_variability_(ms)", "Sleep_performance_"]
    missing_cols = [col for col in required_cols if col not in df.columns]
    if missing_cols:
        raise ValueError(f"Missing required columns: {missing_cols}")

    summary = {
        "Recovery_score_": df["Recovery_score_"].describe(),
        "Resting_heart_rate_(bpm)": df["Resting_heart_rate_(bpm)"].describe(),
        "Heart_rate_variability_(ms)": df["Heart_rate_variability_(ms)"].describe(),
        "Sleep_performance_": df["Sleep_performance_"].describe(),
    }
    summary_stats = {k: v.round(2).to_dict() for k, v in summary.items()}
    avg_sleep_debt = round(df["Sleep_debt_(min)"].mean(), 2) if "Sleep_debt_(min)" in df else "N/A"

    # Distributions & counts
    low_recovery = df[df["Recovery_score_"] < 50][["Cycle_start_time", "Recovery_score_"]] \\
        if "Cycle_start_time" in df.columns else df[df["Recovery_score_"] < 50][["Recovery_score_"]]
    high_sleep_debt = (
        df[df["Sleep_debt_(min)"] > 100][["Cycle_start_time", "Sleep_debt_(min)"]]
        if "Sleep_debt_(min)" in df and "Cycle_start_time" in df.columns
        else df[df.get("Sleep_debt_(min)", pd.Series([])) > 100][["Sleep_debt_(min)"]]
        if "Sleep_debt_(min)" in df else pd.DataFrame()
    )
    low_recovery_count = len(low_recovery)
    high_sleep_debt_count = len(high_sleep_debt)
    total_days = len(df)

    # Charts
    averages = {
        "Recovery": round(df["Recovery_score_"].mean(), 2),
        "Rest HR": round(df["Resting_heart_rate_(bpm)"].mean(), 2),
        "HRV": round(df["Heart_rate_variability_(ms)"].mean(), 2),
        "Sleep Perf": round(df["Sleep_performance_"].mean(), 2),
        "Sleep Debt": round(df["Sleep_debt_(min)"].mean(), 2) if "Sleep_debt_(min)" in df else 0,
    }
    bar_chart = make_bar_chart(averages)

    pie_low_recovery = make_pie_chart(
        ["Low Recovery (<50)", "Normal/High"],
        [low_recovery_count, total_days - low_recovery_count],
        "Low Recovery Days"
    )
    pie_high_sleep_debt = make_pie_chart(
        ["High Sleep Debt (>100)", "Normal/Low"],
        [high_sleep_debt_count, total_days - high_sleep_debt_count],
        "High Sleep Debt Days"
    )

    recovery_dist = {
        "Low": int((df["Recovery_score_"] < 50).sum()),
        "Medium": int(((df["Recovery_score_"] >= 50) & (df["Recovery_score_"] < 80)).sum()),
        "High": int((df["Recovery_score_"] >= 80).sum())
    }
    if "Sleep_debt_(min)" in df:
        sleep_debt_dist = {
            "Low": int((df["Sleep_debt_(min)"] < 30).sum()),
            "Moderate": int(((df["Sleep_debt_(min)"] >= 30) & (df["Sleep_debt_(min)"] < 100)).sum()),
            "High": int((df["Sleep_debt_(min)"] >= 100).sum())
        }
    else:
        sleep_debt_dist = {"Low": 0, "Moderate": 0, "High": 0}

    # Highlights
    best_recovery = df.nlargest(3, "Recovery_score_")[["Cycle_start_time", "Recovery_score_"]] \\
        if "Cycle_start_time" in df.columns else df.nlargest(3, "Recovery_score_")[["Recovery_score_"]]
    worst_recovery = df.nsmallest(3, "Recovery_score_")[["Cycle_start_time", "Recovery_score_"]] \\
        if "Cycle_start_time" in df.columns else df.nsmallest(3, "Recovery_score_")[["Recovery_score_"]]
    best_recovery_html = best_recovery.to_html(index=False, classes='table table-sm') if not best_recovery.empty else "<i>None</i>"
    worst_recovery_html = worst_recovery.to_html(index=False, classes='table table-sm') if not worst_recovery.empty else "<i>None</i>"

    if "Sleep_debt_(min)" in df.columns:
        highest_sleep_debt = df.nlargest(3, "Sleep_debt_(min)")[["Cycle_start_time", "Sleep_debt_(min)"]] \\
            if "Cycle_start_time" in df.columns else df.nlargest(3, "Sleep_debt_(min)")[["Sleep_debt_(min)"]]
        lowest_sleep_debt = df.nsmallest(3, "Sleep_debt_(min)")[["Cycle_start_time", "Sleep_debt_(min)"]] \\
            if "Cycle_start_time" in df.columns else df.nsmallest(3, "Sleep_debt_(min)")[["Sleep_debt_(min)"]]
        highest_sleep_debt_html = highest_sleep_debt.to_html(index=False, classes='table table-sm') if not highest_sleep_debt.empty else "<i>None</i>"
        lowest_sleep_debt_html = lowest_sleep_debt.to_html(index=False, classes='table table-sm') if not lowest_sleep_debt.empty else "<i>None</i>"
    else:
        highest_sleep_debt_html = "<i>Not available</i>"
        lowest_sleep_debt_html = "<i>Not available</i>"

    # Build context
    context = df_to_summary_context(df, summary_stats, recovery_dist, sleep_debt_dist, low_recovery, high_sleep_debt)

    return {
        'success': True,
        'summary_stats': summary_stats,
        'avg_sleep_debt': avg_sleep_debt,
        'low_recovery_count': low_recovery_count,
        'high_sleep_debt_count': high_sleep_debt_count,
        'bar_chart': bar_chart,
        'pie_low_recovery': pie_low_recovery,
        'pie_high_sleep_debt': pie_high_sleep_debt,
        'best_recovery_html': best_recovery_html,
        'worst_recovery_html': worst_recovery_html,
        'highest_sleep_debt_html': highest_sleep_debt_html,
        'lowest_sleep_debt_html': lowest_sleep_debt_html,
        'recovery_dist': recovery_dist,
        'sleep_debt_dist': sleep_debt_dist,
        'context': context
    }

def generate_health_advice(context, prompt):
    """Generate health advice based on context and prompt"""
    if not prompt.strip():
        return "Please ask me something about your health data!"
    
    advice = [
        "🏥 HEALTH & SLEEP COACHING INSIGHTS:",
        "",
        "💡 PERSONALIZED RECOMMENDATIONS:",
        "• Focus on consistency: Same sleep/wake times daily",
        "• Target HRV improvement through stress management & deep breathing",
        "• Monitor recovery trends - avoid high intensity on low recovery days",
        "• Aim for <30min sleep debt consistently",
        "• Consider cold exposure or meditation for recovery enhancement",
        "",
        "📊 YOUR DATA SUMMARY:",
        context[:500] + ("..." if len(context) > 500 else ""),
        "",
        "🎯 SPECIFIC AREAS TO EXPLORE:",
        "• Sleep optimization strategies • Recovery protocols • Stress management • Performance timing"
    ]
    
    return "\\n".join(advice)

print("✅ WHOOP Health Analyzer ready!")
        `);
        
        status.textContent = "✅ Ready to analyze your WHOOP data!";
        status.className = "text-success small mt-2";
        isReady = true;
        
        // Enable UI buttons
        document.getElementById('analyzeBtn').disabled = false;
        document.getElementById('clearBtn').disabled = false;
        document.getElementById('debugBtn').disabled = false;
        document.getElementById('askBtn').disabled = false;
        
    } catch (error) {
        status.textContent = "❌ Failed to initialize: " + error.message;
        status.className = "text-danger small mt-2";
        console.error("Initialization error:", error);
    }
}

// Process WHOOP CSV
async function analyzeWhoopCsv(csvText) {
    const status = document.getElementById('status');
    
    try {
        status.textContent = "🔄 Processing WHOOP data...";
        status.className = "text-primary small mt-2";
        
        // Clear previous errors
        document.getElementById('error').textContent = "";
        
        // Call Python processing function
        const result = pyodide.runPython(`process_whoop_csv("""${csvText.replace(/"/g, '\\"')}""")`);
        const data = result.toJs({dict_hook: Object});
        
        if (!data.success) {
            throw new Error(data.error || "Processing failed");
        }
        
        // Store context
        contextText = data.context || "";
        
        // Update charts
        if (data.bar_chart) {
            document.getElementById('barChart').src = "data:image/png;base64," + data.bar_chart;
        }
        
        if (data.pie_low_recovery) {
            document.getElementById('pieRecovery').src = "data:image/png;base64," + data.pie_low_recovery;
        }
        
        if (data.pie_high_sleep_debt) {
            document.getElementById('pieSleepDebt').src = "data:image/png;base64," + data.pie_high_sleep_debt;
        }
        
        // Update distribution tables
        const recoveryDist = data.recovery_dist || {};
        document.getElementById('recoveryDistTable').innerHTML = `
            <tr><td>Low (&lt;50)</td><td>${recoveryDist.Low || 0}</td></tr>
            <tr><td>Medium (50-79)</td><td>${recoveryDist.Medium || 0}</td></tr>
            <tr><td>High (&ge;80)</td><td>${recoveryDist.High || 0}</td></tr>
        `;
        
        const sleepDebtDist = data.sleep_debt_dist || {};
        document.getElementById('sleepDebtDistTable').innerHTML = `
            <tr><td>Low (&lt;30 min)</td><td>${sleepDebtDist.Low || 0}</td></tr>
            <tr><td>Moderate (30-100 min)</td><td>${sleepDebtDist.Moderate || 0}</td></tr>
            <tr><td>High (&ge;100 min)</td><td>${sleepDebtDist.High || 0}</td></tr>
        `;
        
        // Update highlights
        document.getElementById('bestRecovery').innerHTML = data.best_recovery_html || "<i>None</i>";
        document.getElementById('worstRecovery').innerHTML = data.worst_recovery_html || "<i>None</i>";
        document.getElementById('highestSleepDebt').innerHTML = data.highest_sleep_debt_html || "<i>Not available</i>";
        document.getElementById('lowestSleepDebt').innerHTML = data.lowest_sleep_debt_html || "<i>Not available</i>";
        
        // Update UI state
        document.getElementById('metricsCard').classList.remove('d-none');
        document.getElementById('noContext').style.display = 'none';
        document.getElementById('ctx-badge').className = "badge text-bg-success ms-2";
        document.getElementById('ctx-badge').textContent = "Context: True";
        
        status.textContent = "✅ Analysis complete!";
        status.className = "text-success small mt-2";
        
    } catch (error) {
        document.getElementById('error').textContent = "❌ Processing error: " + error.message;
        status.textContent = "❌ Processing failed";
        status.className = "text-danger small mt-2";
        console.error("Processing error:", error);
    }
}

// Event handlers
document.getElementById('csvFile').addEventListener('change', (e) => {
    document.getElementById('error').textContent = "";
    if (e.target.files.length > 0) {
        const fileName = e.target.files[0].name;
        document.getElementById('status').textContent = `📄 Selected: ${fileName}`;
    }
});

document.getElementById('analyzeBtn').addEventListener('click', async () => {
    if (!isReady) {
        document.getElementById('error').textContent = "⏳ Please wait for Python environment to finish loading...";
        return;
    }
    
    const fileInput = document.getElementById('csvFile');
    const file = fileInput.files[0];
    
    if (!file) {
        document.getElementById('error').textContent = "📁 Please select a CSV file first.";
        return;
    }
    
    if (!file.name.toLowerCase().endsWith('.csv')) {
        document.getElementById('error').textContent = "📄 Please upload a CSV file (.csv extension required).";
        return;
    }
    
    try {
        const text = await file.text();
        if (!text.trim()) {
            document.getElementById('error').textContent = "📄 The uploaded file appears to be empty.";
            return;
        }
        
        await analyzeWhoopCsv(text);
    } catch (error) {
        document.getElementById('error').textContent = "📄 Error reading file: " + error.message;
        console.error("File reading error:", error);
    }
});

document.getElementById('clearBtn').addEventListener('click', () => {
    // Reset variables
    contextText = "";
    
    // Reset UI elements
    document.getElementById('metricsCard').classList.add('d-none');
    document.getElementById('noContext').style.display = 'block';
    document.getElementById('ctx-badge').className = "badge text-bg-secondary ms-2";
    document.getElementById('ctx-badge').textContent = "Context: False";
    document.getElementById('error').textContent = "";
    document.getElementById('answer').textContent = "";
    document.getElementById('answerDiv').classList.add('d-none');
    document.getElementById('answerHr').classList.add('d-none');
    document.getElementById('csvFile').value = "";
    document.getElementById('promptBox').value = "";
    document.getElementById('status').textContent = "✅ Ready to analyze your WHOOP data!";
    document.getElementById('status').className = "text-success small mt-2";
});

document.getElementById('debugBtn').addEventListener('click', () => {
    const debugInfo = {
        pyodide_ready: isReady,
        has_context: !!contextText,
        context_length: contextText.length,
        context_preview: contextText.substring(0, 200) + "..."
    };
    alert("🐛 DEBUG INFO:\\n" + JSON.stringify(debugInfo, null, 2));
});

document.getElementById('askBtn').addEventListener('click', async () => {
    const prompt = document.getElementById('promptBox').value.trim();
    
    if (!contextText) {
        document.getElementById('error').textContent = "📊 Please upload and analyze a CSV file first to provide context.";
        return;
    }
    
    if (!prompt) {
        document.getElementById('error').textContent = "💬 Please enter a question about your health data.";
        return;
    }
    
    if (!isReady) {
        document.getElementById('error').textContent = "⏳ Python environment not ready yet. Please wait.";
        return;
    }
    
    try {
        document.getElementById('error').textContent = "";
        
        const response = pyodide.runPython(`
generate_health_advice("""${contextText.replace(/"/g, '\\"')}""", """${prompt.replace(/"/g, '\\"')}""")
        `);
        
        document.getElementById('answerHr').classList.remove('d-none');
        document.getElementById('answerDiv').classList.remove('d-none');
        document.getElementById('answer').textContent = response;
        
    } catch (error) {
        document.getElementById('error').textContent = "🤖 Error generating health advice: " + error.message;
        console.error("Advice generation error:", error);
    }
});

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initPyodide);
</script>
</body>
</html>