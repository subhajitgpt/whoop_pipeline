<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Health & Sleep Analyzer — Pyodide</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body { padding: 20px; background: #f7f9fc; }
    .monospace { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; }
    .img-box { border: 1px solid #e7eef5; border-radius: 10px; padding: 6px; background: #fff; box-shadow: 0 2px 6px rgba(16,24,40,.04); }
    .viz-img { width: 100%; height: 100%; object-fit: contain; }
    .section-title { font-weight: 700; color: #0f172a; }
    .card-soft { border: 1px solid #e7eef5; box-shadow: 0 2px 6px rgba(16,24,40,.04); background:#fff; }
    .min-h { min-height: 40px; }

    .metric-chip { font-weight: 600; padding: .35rem .6rem; border-radius: 999px; }
    .metric-chip.primary { background: #e8f1ff; color: #0b63ce; }
    .metric-chip.success { background: #e9f9ef; color: #0f8f3d; }
    .metric-chip.warning { background: #fff6e5; color: #b96a00; }
    .metric-chip.danger  { background: #ffe9e9; color: #cc2e2e; }

    .progress { height: 10px; background-color: #eef2f7; }
    .progress-bar { background-image: linear-gradient(90deg, #1976D2, #2F80ED); }
    .progress-bar.warn { background-image: linear-gradient(90deg, #FF9800, #FFB74D); }
    .progress-bar.ok   { background-image: linear-gradient(90deg, #16a34a, #22c55e); }
    .progress-bar.bad  { background-image: linear-gradient(90deg, #ef4444, #f97393); }

    .list-compact .list-group-item{
      padding:.5rem .75rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.75rem;
    }
    .list-compact .list-group-item span:first-child{
      flex:1 1 auto;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    /* Fixed badge width so numbers align in a column */
    .list-compact .badge{
      font-size:.8rem;
      min-width: 72px;
      text-align:right;
    }

    .equal-col { display:flex; flex-direction:column; }
    .equal-fill { flex:1 1 auto; }

    .spinner { display:inline-block; width:1rem; height:1rem; border:2px solid #cbd5e1; border-top-color:#2563eb; border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div class="container my-4">

  <div class="card card-soft mb-3">
    <div class="card-body">
      <h5 class="card-title">1) Upload WHOOP CSV
        <span id="ctx-badge" class="badge text-bg-secondary ms-2">Context: False</span>
      </h5>
      <div class="row g-2 align-items-center">
        <div class="col-auto"><input id="csvFile" class="form-control" type="file" accept=".csv" required></div>
        <div class="col-auto"><button id="analyzeBtn" class="btn btn-primary" disabled>Analyze</button></div>
        <div class="col-auto"><button id="clearBtn" class="btn btn-outline-secondary" disabled>Clear context</button></div>
        <div class="col-auto"><button id="debugBtn" class="btn btn-outline-dark" disabled>/debug</button></div>
      </div>
      <div id="error" class="text-danger mt-2 min-h"></div>
      <div id="status" class="text-secondary small mt-2">🔄 Initializing Python environment...</div>
    </div>
  </div>

  <div id="metricsCard" class="card card-soft mb-3 d-none">
    <div class="card-body">
      <h3 class="card-title section-title">Extracted Metrics</h3>

      <div class="row g-3">
        <div class="col-md-7 equal-col">
          <h6 class="mb-2">Overall Metrics (Bar Chart)</h6>
          <div class="img-box equal-fill"><img id="barChart" class="img-fluid" alt="Average Metrics"></div>
        </div>

        <div class="col-md-5 equal-col">
          <h6 class="mb-2">Recovery & Sleep Debt Proportions</h6>

          <div class="row g-3 equal-fill">
            <div class="col-6">
              <div class="img-box ratio ratio-1x1">
                <img id="pieRecovery" class="viz-img" alt="Low Recovery Pie">
              </div>
            </div>
            <div class="col-6">
              <div class="img-box ratio ratio-1x1">
                <img id="pieSleepDebt" class="viz-img" alt="High Sleep Debt Pie">
              </div>
            </div>

            <div class="col-12">
              <div class="img-box p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Quick Insights</h6>
                  <span id="qi-days" class="badge text-bg-light">— days</span>
                </div>

                <div class="row g-2">
                  <div class="col-6">
                    <div class="small text-secondary">Avg Recovery</div>
                    <div class="d-flex align-items-center gap-2">
                      <span id="qi-avg-recov" class="fw-bold"></span>
                      <span id="qi-recov-band" class="metric-chip"></span>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="small text-secondary">Avg HRV (ms)</div>
                    <div class="fw-bold"><span id="qi-avg-hrv"></span></div>
                  </div>
                  <div class="col-6">
                    <div class="small text-secondary">% Low Recovery</div>
                    <div class="fw-bold"><span id="qi-lowrecov-pct"></span></div>
                  </div>
                  <div class="col-6">
                    <div class="small text-secondary">% High Sleep Debt</div>
                    <div class="fw-bold"><span id="qi-highdebt-pct"></span></div>
                  </div>

                  <div class="col-12">
                    <hr class="my-2">
                    <div class="small text-secondary mb-1">Notable Days</div>
                    <ul class="small mb-0" id="qi-notable"></ul>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

      <hr>

      <div class="row g-3">
        <div class="col-md-6">
          <div class="card card-soft h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Recovery Score Distribution</h6>
                <span id="recoveryTotal" class="badge text-bg-light">0 days</span>
              </div>

              <div class="d-flex justify-content-between">
                <span class="metric-chip danger">Low &lt;50</span>
                <span id="recoveryLowLbl" class="fw-semibold">0</span>
              </div>
              <div class="progress my-2"><div id="recoveryLowBar" class="progress-bar bad" style="width:0%"></div></div>

              <div class="d-flex justify-content-between mt-2">
                <span class="metric-chip warning">Medium 50–79</span>
                <span id="recoveryMedLbl" class="fw-semibold">0</span>
              </div>
              <div class="progress my-2"><div id="recoveryMedBar" class="progress-bar warn" style="width:0%"></div></div>

              <div class="d-flex justify-content-between mt-2">
                <span class="metric-chip success">High ≥80</span>
                <span id="recoveryHighLbl" class="fw-semibold">0</span>
              </div>
              <div class="progress my-2"><div id="recoveryHighBar" class="progress-bar ok" style="width:0%"></div></div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card card-soft h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Sleep Debt Distribution</h6>
                <span id="sleepDebtTotal" class="badge text-bg-light">0 days</span>
              </div>

              <div class="d-flex justify-content-between">
                <span class="metric-chip success">Low &lt;30 min</span>
                <span id="sleepLowLbl" class="fw-semibold">0</span>
              </div>
              <div class="progress my-2"><div id="sleepLowBar" class="progress-bar ok" style="width:0%"></div></div>

              <div class="d-flex justify-content-between mt-2">
                <span class="metric-chip warning">Moderate 30–100</span>
                <span id="sleepModLbl" class="fw-semibold">0</span>
              </div>
              <div class="progress my-2"><div id="sleepModBar" class="progress-bar warn" style="width:0%"></div></div>

              <div class="d-flex justify-content-between mt-2">
                <span class="metric-chip danger">High ≥100</span>
                <span id="sleepHighLbl" class="fw-semibold">0</span>
              </div>
              <div class="progress my-2"><div id="sleepHighBar" class="progress-bar bad" style="width:0%"></div></div>
            </div>
          </div>
        </div>
      </div>

      <hr>

      <h6 class="mb-2">Highlights</h6>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="card card-soft h-100">
            <div class="card-body">
              <h6 class="mb-2">Top 3 Best Recovery Days</h6>
              <div id="bestRecovery" class="list-group list-compact mb-3"></div>
              <h6 class="mb-2">Top 5 Worst Recovery Days</h6>
              <div id="worstRecovery" class="list-group list-compact"></div>
            </div>
          </div>
        </div>

        <!-- NEW: Sleep Debt lists -->
        <div class="col-md-6">
          <div class="card card-soft h-100">
            <div class="card-body">
              <h6 class="mb-2">Top 3 Lowest Sleep Debt Days</h6>
              <div id="lowestSleepDebt" class="list-group list-compact mb-3"></div>

              <h6 class="mb-2">Top 5 Highest Sleep Debt Days</h6>
              <div id="highestSleepDebt" class="list-group list-compact"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ====== OPENAI CHAT SECTION ====== -->
  <div class="card card-soft">
    <div class="card-body">
      <h5 class="card-title">2) Chat about this data</h5>
      <div id="noContext" class="text-secondary">Upload a CSV first to give the assistant context. You can still type a question—I'll remind you.</div>

      <div class="row g-2 align-items-end mb-2">
        <div class="col-md-6">
          <label class="form-label mb-1">OpenAI API Key</label>
          <input id="openaiKey" type="password" class="form-control" placeholder="sk-...">
          <div class="form-text">Stored locally in your browser if you click “Remember”. For production, use a backend proxy.</div>
        </div>
        <div class="col-md-3">
          <label class="form-label mb-1">Model</label>
          <select id="openaiModel" class="form-select">
            <option value="gpt-4o-mini" selected>gpt-4o-mini (fast, cheap)</option>
            <option value="gpt-4o">gpt-4o (best quality)</option>
            <option value="gpt-4.1-mini">gpt-4.1-mini</option>
          </select>
        </div>
        <div class="col-md-3">
          <div class="form-check mb-1">
            <input class="form-check-input" type="checkbox" id="rememberKey">
            <label class="form-check-label" for="rememberKey">Remember key on this device</label>
          </div>
        </div>
      </div>

      <textarea id="promptBox" class="form-control" rows="4" placeholder="E.g., Suggest a 7-day plan to improve HRV given my averages and bad days."></textarea>
      <div class="mt-3 d-flex gap-2">
        <button id="askBtn" class="btn btn-primary" disabled>Ask</button>
        <span id="askStatus" class="text-secondary small"></span>
      </div>
      <hr class="d-none" id="answerHr">
      <div id="answerDiv" class="d-none">
        <div><b>Assistant:</b></div>
        <pre id="answer" class="monospace"></pre>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js"></script>
<script>
let pyodide = null;
let isReady = false;
let contextText = "";

/* -------- INIT PYODIDE -------- */
async function initPyodide() {
  const status = document.getElementById('status');
  try {
    status.textContent = "🔄 Loading Pyodide...";
    pyodide = await loadPyodide();
    status.textContent = "📦 Installing packages...";
    await pyodide.loadPackage(['numpy','pandas','matplotlib']);
    status.textContent = "🔧 Setting up functions...";
    pyodide.runPython(`
import io, base64
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib import use
use('Agg')

def plot_to_base64(fig):
    buf = io.BytesIO()
    fig.savefig(buf, format="png", bbox_inches='tight', dpi=144)
    buf.seek(0)
    b64 = base64.b64encode(buf.read()).decode('utf-8')
    plt.close(fig)
    return b64

def make_nicer_pie_chart(labels, sizes, title):
    fig, ax = plt.subplots(figsize=(8, 6))
    colors = ['#FF9800', '#FFE0B2', '#FFB74D', '#FFCC80', '#FFA726', '#F57C00']
    explode = [0.08 if i == np.argmax(sizes) else 0.03 for i in range(len(sizes))]
    wedges, texts, autotexts = ax.pie(
        sizes, labels=labels, autopct='%1.1f%%', startangle=120, colors=colors[:len(labels)],
        explode=explode, shadow=False,
        wedgeprops=dict(width=0.55, edgecolor='white', linewidth=2),
        textprops=dict(color="#111", fontsize=13, fontweight="bold")
    )
    ax.set_title(title, fontsize=16, fontweight='bold', color='#333')
    for t in autotexts: t.set_fontsize(13)
    ax.axis('equal')
    fig.tight_layout()
    return plot_to_base64(fig)

def make_bar_chart(averages):
    fig, ax = plt.subplots(figsize=(8, 6))
    keys=list(averages.keys()); values=list(averages.values())
    bars = ax.bar(keys, values, color='#1976D2')
    ax.set_ylabel('Average Value', fontsize=13)
    ax.set_title('Average Key Metrics', fontsize=16, pad=10)
    plt.xticks(rotation=20, fontsize=12)
    ymax=max(values)*1.2 if max(values)>0 else 1
    ax.set_ylim([0, ymax])
    for b in bars:
        ax.text(b.get_x()+b.get_width()/2, b.get_height()+ymax*0.02, f'{b.get_height():.1f}',
                ha='center', va='bottom', fontsize=12, fontweight='bold',
                color='#1976D2',
                bbox=dict(facecolor='white', edgecolor='#1976D2', boxstyle='round,pad=0.2'))
    fig.tight_layout()
    return plot_to_base64(fig)

def to_json_rows(df):
    try:
        return df.to_json(orient='records')
    except Exception:
        return "[]"

def process_whoop_csv(csv_text):
    df = pd.read_csv(io.StringIO(csv_text))
    df.columns = [c.strip().replace(' ', '_') for c in df.columns]

    req=["Recovery_score_%","Resting_heart_rate_(bpm)","Heart_rate_variability_(ms)","Sleep_performance_%"]
    miss=[c for c in req if c not in df.columns]
    if miss: raise ValueError(f"Missing required columns: {miss}")

    averages = {
        "Recovery": round(df["Recovery_score_%"].mean(), 2),
        "Rest_HR": round(df["Resting_heart_rate_(bpm)"].mean(), 2),
        "HRV": round(df["Heart_rate_variability_(ms)"].mean(), 2),
        "Sleep_Perf": round(df["Sleep_performance_%"].mean(), 2),
        "Sleep_Debt": round(df["Sleep_debt_(min)"].mean(), 2) if "Sleep_debt_(min)" in df else 0,
    }
    total_days = int(len(df))

    rec_low = int((df["Recovery_score_%"] < 50).sum())
    rec_med = int(((df["Recovery_score_%"] >= 50) & (df["Recovery_score_%"] < 80)).sum())
    rec_high = int((df["Recovery_score_%"] >= 80).sum())
    recovery_dist = {"Low": rec_low, "Medium": rec_med, "High": rec_high}

    # ---- Sleep debt calculations for lists & distributions ----
    if "Sleep_debt_(min)" in df:
        sd_series = pd.to_numeric(df["Sleep_debt_(min)"], errors="coerce").dropna()
        sd_low  = int((sd_series < 30).sum())
        sd_mod  = int(((sd_series >= 30) & (sd_series < 100)).sum())
        sd_high = int((sd_series >= 100).sum())
        sleep_debt_dist = {"Low": sd_low, "Moderate": sd_mod, "High": sd_high}

        # New: top/bottom lists for Sleep Debt
        if "Cycle_start_time" in df.columns:
            ls = df.nsmallest(3, "Sleep_debt_(min)")[["Cycle_start_time","Sleep_debt_(min)"]]
            hs = df.nlargest(5, "Sleep_debt_(min)")[["Cycle_start_time","Sleep_debt_(min)"]]
        else:
            ls = df.nsmallest(3, "Sleep_debt_(min)")[["Sleep_debt_(min)"]]
            hs = df.nlargest(5, "Sleep_debt_(min)")[["Sleep_debt_(min)"]]
        lowest_sleep_json = to_json_rows(ls)
        highest_sleep_json = to_json_rows(hs)
    else:
        sleep_debt_dist = {"Low": 0, "Moderate": 0, "High": 0}
        lowest_sleep_json = "[]"
        highest_sleep_json = "[]"

    bar_chart = make_bar_chart(averages)
    pie_low_recovery = make_nicer_pie_chart(["Low Recovery (<50)","Normal/High"], [rec_low, total_days-rec_low], "Low Recovery Days")
    high_sleep_debt_count = sleep_debt_dist["High"]
    pie_high_sleep_debt = make_nicer_pie_chart(["High Sleep Debt (>100)","Normal/Low"], [high_sleep_debt_count, total_days-high_sleep_debt_count], "High Sleep Debt Days")

    br = df.nlargest(3, "Recovery_score_%")[["Cycle_start_time","Recovery_score_%"]] if "Cycle_start_time" in df.columns else df.nlargest(3, "Recovery_score_%")[["Recovery_score_%"]]
    wr = df.nsmallest(5, "Recovery_score_%")[["Cycle_start_time","Recovery_score_%"]] if "Cycle_start_time" in df.columns else df.nsmallest(5, "Recovery_score_%")[["Recovery_score_%"]]

    best_hrv_row = df.loc[df["Heart_rate_variability_(ms)"].idxmax()][["Cycle_start_time","Heart_rate_variability_(ms)"]] if "Cycle_start_time" in df.columns else None
    worst_rest_row = df.loc[df["Resting_heart_rate_(bpm)"].idxmax()][["Cycle_start_time","Resting_heart_rate_(bpm)"]] if "Cycle_start_time" in df.columns else None
    best_sleep_perf_row = df.loc[df["Sleep_performance_%"].idxmax()][["Cycle_start_time","Sleep_performance_%"]] if "Cycle_start_time" in df.columns else None

    return {
        "success": True,
        "averages": averages,
        "total_days": total_days,
        "recovery_dist": recovery_dist,
        "sleep_debt_dist": sleep_debt_dist,
        "bar_chart": bar_chart,
        "pie_low_recovery": pie_low_recovery,
        "pie_high_sleep_debt": pie_high_sleep_debt,
        "best_recovery_json": to_json_rows(br),
        "worst_recovery_json": to_json_rows(wr),
        "lowest_sleep_debt_json": lowest_sleep_json,
        "highest_sleep_debt_json": highest_sleep_json,
        "notables": {
            "best_hrv": None if best_hrv_row is None else {"when": str(best_hrv_row["Cycle_start_time"]), "value": float(best_hrv_row["Heart_rate_variability_(ms)"])},
            "worst_rest_hr": None if worst_rest_row is None else {"when": str(worst_rest_row["Cycle_start_time"]), "value": float(worst_rest_row["Resting_heart_rate_(bpm)"])},
            "best_sleep_perf": None if best_sleep_perf_row is None else {"when": str(best_sleep_perf_row["Cycle_start_time"]), "value": float(best_sleep_perf_row["Sleep_performance_%"])}
        }
    }
    `);
    status.textContent = "✅ Ready to analyze your WHOOP data!";
    status.className = "text-success small mt-2";
    isReady = true;
    document.getElementById('analyzeBtn').disabled = false;
    document.getElementById('clearBtn').disabled = false;
    document.getElementById('debugBtn').disabled = false;
    document.getElementById('askBtn').disabled = false;

    const saved = localStorage.getItem('openai_api_key');
    if (saved) { document.getElementById('openaiKey').value = saved; document.getElementById('rememberKey').checked = true; }
  } catch (e) {
    status.textContent = "❌ Failed to initialize: " + e.message;
    status.className = "text-danger small mt-2";
    console.error(e);
  }
}

/* -------- Helpers -------- */
function pct(n,t){ return t ? Math.round((n/t)*100) : 0; }
function renderRowsFromJson(jsonStr, valueKey, unit, badgeClass){
  const list=document.createElement('div'); list.className='list-group list-compact';
  let rows=[]; try{rows=JSON.parse(jsonStr||"[]");}catch{rows=[];}
  if(!rows.length){list.innerHTML='<div class="text-secondary small"><i>None</i></div>'; return list;}
  rows.forEach(r=>{
    const when=r.Cycle_start_time||'—';
    const val=r[valueKey]!=null?r[valueKey]:'—';
    const item=document.createElement('div'); item.className='list-group-item';
    item.innerHTML=`<span class="text-truncate" style="max-width:60%">${when}</span>
                    <span class="badge ${badgeClass}">${val}${unit}</span>`;
    list.appendChild(item);
  });
  return list;
}

/* -------- WHOOP processing -------- */
async function analyzeWhoopCsv(csvText){
  const status=document.getElementById('status');
  try{
    status.textContent="🔄 Processing WHOOP data..."; status.className="text-primary small mt-2";
    document.getElementById('error').textContent="";
    const result=pyodide.runPython(`process_whoop_csv("""${csvText.replace(/"/g,'\\"')}""")`);
    const data=result.toJs({dict_hook:Object});
    if(!data.success) throw new Error("Processing failed");

    document.getElementById('barChart').src="data:image/png;base64,"+data.bar_chart;
    document.getElementById('pieRecovery').src="data:image/png;base64,"+data.pie_low_recovery;
    document.getElementById('pieSleepDebt').src="data:image/png;base64,"+data.pie_high_sleep_debt;

    const days=data.total_days||0;
    document.getElementById('qi-days').textContent=`${days} days`;
    const av=data.averages||{};
    const avgRec=av.Recovery??0, avgHRV=av.HRV??0;
    document.getElementById('qi-avg-recov').textContent=`${avgRec.toFixed(1)}%`;
    document.getElementById('qi-avg-hrv').textContent=`${avgHRV.toFixed(1)}`;
    const band=document.getElementById('qi-recov-band');
    if(avgRec>=80){band.textContent="High"; band.className="metric-chip success";}
    else if(avgRec>=50){band.textContent="Medium"; band.className="metric-chip warning";}
    else {band.textContent="Low"; band.className="metric-chip danger";}
    const rec=data.recovery_dist||{}; const sd=data.sleep_debt_dist||{};
    document.getElementById('qi-lowrecov-pct').textContent=`${pct(rec.Low||0,(rec.Low||0)+(rec.Medium||0)+(rec.High||0))}%`;
    document.getElementById('qi-highdebt-pct').textContent=`${pct(sd.High||0,(sd.Low||0)+(sd.Moderate||0)+(sd.High||0))}%`;

    const ul=document.getElementById('qi-notable'); ul.innerHTML="";
    const n=data.notables||{};
    if(n.best_hrv) ul.innerHTML+=`<li>Best HRV: <b>${n.best_hrv.value.toFixed(1)}</b> ms on <span class="text-secondary">${n.best_hrv.when}</span></li>`;
    if(n.worst_rest_hr) ul.innerHTML+=`<li>Highest Rest HR: <b>${n.worst_rest_hr.value.toFixed(1)}</b> bpm on <span class="text-secondary">${n.worst_rest_hr.when}</span></li>`;
    if(n.best_sleep_perf) ul.innerHTML+=`<li>Best Sleep Performance: <b>${n.best_sleep_perf.value.toFixed(1)}</b>% on <span class="text-secondary">${n.best_sleep_perf.when}</span></li>`;
    if(!ul.innerHTML) ul.innerHTML="<li><i>No notable days computed.</i></li>";

    const recTotal=(rec.Low||0)+(rec.Medium||0)+(rec.High||0);
    document.getElementById('recoveryTotal').textContent=`${recTotal} days`;
    document.getElementById('recoveryLowLbl').textContent=`${rec.Low||0} (${pct(rec.Low||0,recTotal)}%)`;
    document.getElementById('recoveryMedLbl').textContent=`${rec.Medium||0} (${pct(rec.Medium||0,recTotal)}%)`;
    document.getElementById('recoveryHighLbl').textContent=`${rec.High||0} (${pct(rec.High||0,recTotal)}%)`;
    document.getElementById('recoveryLowBar').style.width=pct(rec.Low||0,recTotal)+'%';
    document.getElementById('recoveryMedBar').style.width=pct(rec.Medium||0,recTotal)+'%';
    document.getElementById('recoveryHighBar').style.width=pct(rec.High||0,recTotal)+'%';

    const sdTotal=(sd.Low||0)+(sd.Moderate||0)+(sd.High||0);
    document.getElementById('sleepDebtTotal').textContent=`${sdTotal} days`;
    document.getElementById('sleepLowLbl').textContent=`${sd.Low||0} (${pct(sd.Low||0,sdTotal)}%)`;
    document.getElementById('sleepModLbl').textContent=`${sd.Moderate||0} (${pct(sd.Moderate||0,sdTotal)}%)`;
    document.getElementById('sleepHighLbl').textContent=`${sd.High||0} (${pct(sd.High||0,sdTotal)}%)`;
    document.getElementById('sleepLowBar').style.width=pct(sd.Low||0,sdTotal)+'%';
    document.getElementById('sleepModBar').style.width=pct(sd.Moderate||0,sdTotal)+'%';
    document.getElementById('sleepHighBar').style.width=pct(sd.High||0,sdTotal)+'%';

    // Recovery lists
    const bestWrap=document.getElementById('bestRecovery'); bestWrap.innerHTML='';
    bestWrap.appendChild(renderRowsFromJson(data.best_recovery_json,'Recovery_score_%','%','text-bg-success'));
    const worstWrap=document.getElementById('worstRecovery'); worstWrap.innerHTML='';
    worstWrap.appendChild(renderRowsFromJson(data.worst_recovery_json,'Recovery_score_%','%','text-bg-danger'));

    // Sleep debt lists (new)
    const lowDebtWrap = document.getElementById('lowestSleepDebt'); lowDebtWrap.innerHTML='';
    const highDebtWrap = document.getElementById('highestSleepDebt'); highDebtWrap.innerHTML='';
    lowDebtWrap.appendChild(renderRowsFromJson(data.lowest_sleep_debt_json,'Sleep_debt_(min)',' min','text-bg-success'));
    highDebtWrap.appendChild(renderRowsFromJson(data.highest_sleep_debt_json,'Sleep_debt_(min)',' min','text-bg-danger'));

    document.getElementById('metricsCard').classList.remove('d-none');
    document.getElementById('noContext').style.display='none';
    document.getElementById('ctx-badge').className="badge text-bg-success ms-2";
    document.getElementById('ctx-badge').textContent="Context: True";
    status.textContent="✅ Analysis complete!"; status.className="text-success small mt-2";
  }catch(e){
    document.getElementById('error').textContent="❌ Processing error: "+e.message;
    document.getElementById('status').textContent="❌ Processing failed"; document.getElementById('status').className="text-danger small mt-2";
    console.error(e);
  }
}

/* -------- OpenAI Chat -------- */
async function callOpenAI({apiKey, model, userPrompt, context}) {
  const askStatus = document.getElementById('askStatus');
  askStatus.innerHTML = `<span class="spinner"></span> contacting OpenAI…`;
  const system = `You are a helpful health & sleep coach. Use the provided WHOOP summary context to answer concretely with specific actions. If numbers are referenced, cite them from the context. Avoid medical diagnoses. Context: """${context}"""`;
  const body = {
    model,
    messages: [
      { role: "system", content: system },
      { role: "user", content: userPrompt }
    ],
    temperature: 0.7
  };
  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + apiKey
    },
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const text = await res.text();
    throw new Error(`OpenAI error ${res.status}: ${text}`);
  }
  const data = await res.json();
  askStatus.textContent = "✅";
  return data.choices?.[0]?.message?.content ?? "(no content)";
}

/* -------- UI wires -------- */
document.getElementById('csvFile').addEventListener('change', (e) => {
  document.getElementById('error').textContent = "";
  if (e.target.files.length > 0) {
    document.getElementById('status').textContent = `📄 Selected: ${e.target.files[0].name}`;
  }
});

document.getElementById('analyzeBtn').addEventListener('click', async () => {
  if (!isReady) { document.getElementById('error').textContent = "⏳ Please wait for Python environment to finish loading..."; return; }
  const file = document.getElementById('csvFile').files[0];
  if (!file) { document.getElementById('error').textContent = "📁 Please select a CSV file first."; return; }
  if (!file.name.toLowerCase().endsWith('.csv')) { document.getElementById('error').textContent = "📄 Please upload a CSV (.csv)."; return; }
  const text = await file.text();
  if (!text.trim()) { document.getElementById('error').textContent = "📄 The uploaded file appears to be empty."; return; }
  await analyzeWhoopCsv(text);
});

document.getElementById('clearBtn').addEventListener('click', () => {
  contextText = "";
  document.getElementById('metricsCard').classList.add('d-none');
  document.getElementById('noContext').style.display = 'block';
  document.getElementById('ctx-badge').className = "badge text-bg-secondary ms-2";
  document.getElementById('ctx-badge').textContent = "Context: False";
  document.getElementById('error').textContent = "";
  document.getElementById('answer').textContent = "";
  document.getElementById('answerDiv').classList.add('d-none');
  document.getElementById('answerHr').classList.add('d-none');
  document.getElementById('csvFile').value = "";
  document.getElementById('promptBox').value = "";
  document.getElementById('status').textContent = "✅ Ready to analyze your WHOOP data!";
  document.getElementById('status').className = "text-success small mt-2";
});

document.getElementById('debugBtn').addEventListener('click', () => {
  alert("🐛 DEBUG INFO: Pyodide ready = " + isReady);
});

document.getElementById('askBtn').addEventListener('click', async () => {
  const prompt = document.getElementById('promptBox').value.trim();
  const key = document.getElementById('openaiKey').value.trim();
  const model = document.getElementById('openaiModel').value;
  if (!key) { document.getElementById('error').textContent = "🔐 Enter your OpenAI API key."; return; }
  if (!prompt) { document.getElementById('error').textContent = "💬 Please enter a question about your health data."; return; }
  if (!isReady) { document.getElementById('error').textContent = "⏳ Python environment not ready yet."; return; }
  try {
    document.getElementById('error').textContent = "";
    const recDist = document.getElementById('recoveryTotal').textContent;
    const sdDist  = document.getElementById('sleepDebtTotal').textContent;
    const qi = {
      days: document.getElementById('qi-days').textContent,
      avgRecovery: document.getElementById('qi-avg-recov').textContent,
      avgHRV: document.getElementById('qi-avg-hrv').textContent,
      pctLowRecovery: document.getElementById('qi-lowrecov-pct').textContent,
      pctHighSleepDebt: document.getElementById('qi-highdebt-pct').textContent
    };
    const contextBlob = `Days=${qi.days}; AvgRecovery=${qi.avgRecovery}; AvgHRV=${qi.avgHRV}; LowRecovery%=${qi.pctLowRecovery}; HighSleepDebt%=${qi.pctHighSleepDebt}; RecoveryTotal=${recDist}; SleepDebtTotal=${sdDist}.`;

    if (document.getElementById('rememberKey').checked) {
      localStorage.setItem('openai_api_key', key);
    } else {
      localStorage.removeItem('openai_api_key');
    }

    const reply = await callOpenAI({
      apiKey: key,
      model,
      userPrompt: `${prompt}\n\nUse this summary context:\n${contextBlob}`,
      context: contextBlob
    });

    document.getElementById('answerHr').classList.remove('d-none');
    document.getElementById('answerDiv').classList.remove('d-none');
    document.getElementById('answer').textContent = reply;
  } catch (e) {
    document.getElementById('askStatus').textContent = "";
    document.getElementById('error').textContent = "🤖 Chat error: " + e.message;
    console.error(e);
  }
});

document.addEventListener('DOMContentLoaded', initPyodide);
</script>
</body>
</html>
